<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direcionamento de Cirurgia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; } /* Habilita a rolagem suave */
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: #374151; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="app" class="max-w-full mx-auto">
        <header class="mb-8 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Direcionamento de Cirurgias</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Gerencie tabelas e procedimentos de forma interativa.</p>
                </div>
                <div class="mt-4 md:mt-0 flex flex-wrap items-center justify-center gap-3">
                    <button id="add-table-btn" class="w-full sm:w-auto bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition">Criar Tabela</button>
                    <button id="suggestion-btn" class="w-full sm:w-auto bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition">Ver Sugestões</button>
                    <button id="save-btn" class="w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition">Salvar</button>
                    <button id="export-btn" class="w-full sm:w-auto bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition">Exportar</button>
                    <button id="reset-btn" class="w-full sm:w-auto bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition">Resetar</button>
                    <button id="theme-toggle-btn" title="Alternar tema" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                        <svg id="theme-toggle-moon-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                        <svg id="theme-toggle-sun-icon" xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <label for="search-input" class="sr-only">Pesquisar Procedimento</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                    </div>
                    <input type="text" id="search-input" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Pesquisar por procedimento ou tabela...">
                </div>
            </div>
            <div class="mt-4 p-3 bg-blue-100 dark:bg-gray-700 border-l-4 border-blue-500 text-blue-800 dark:text-blue-300 rounded-md">
                <p class="font-bold">Como funciona o salvamento?</p>
                <p>Suas alterações são salvas diretamente no seu navegador. Clique em <strong class="font-semibold">"Salvar"</strong> e seus dados estarão aqui quando você reabrir a página.</p>
            </div>
        </header>

        <main id="tables-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></main>

        <section id="suggestion-section" class="mt-12 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Sugestões de Confecção de Kits</h2>
            <div id="suggestion-content">
                </div>
        </section>

    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100"></h3>
            <div id="modal-content" class="text-gray-700 dark:text-gray-300"></div>
            <div class="mt-6 flex justify-end gap-3"><button id="modal-cancel" class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-100 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Cancelar</button><button id="modal-confirm" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Confirmar</button></div>
        </div>
    </div>

    <script>
        // --- MODIFICADO --- Adicionado 'targetStock' aos dados iniciais
        const initialData = [
            { title: "UROLOGIA PEQUENO", procedures: ["VASECTOMIA", "POSTECTOMIA", "CISTOSCOPIA", "VARICOCELE", "HIDROCELE"], stock: 0, targetStock: 10 },
            { title: "UROLOGIA MÉDIO", procedures: ["MEATOPLASTIA", "PROSTATECTOMIA", "CISTOTOMIA", "ORQUIECTOMIA", "URETERORRENOLITOTRIPSIA", "NEFRECTOMIA TOTAL", "URETROTOMIA", "RTU DE PRÓSTATA", "LOMBOTOMIA"], stock: 0, targetStock: 10 },
            { title: "UROLOGIA GRANDE", procedures: ["RADICAL DE PRÓSTATA", "NEFRECTOMIA", "PIELOPLASTIA", "RTU DE PRÓSTATA"], stock: 0, targetStock: 5 },
            { title: "PEQUENO PROCEDIMENTO", procedures: ["DRENAGEMDE ABCESSO", "BRONCOSCOPIA", "VARIZES", "EXERESE DE TUMOR DE PELE", "RECONSTRUÇÃO COM RETALHO MIOCUTÂNIO", "ENXERTO DE PELE", "EXCISÃO E SUTURA DE LESÃO NA PELE EM Z OU ROTACA", "Linfadenectomia inguinal"], stock: 0, targetStock: 15 },
            { title: "CÁRDIO", procedures: ["REVASCULARIZAÇÃO", "IMPLANTE DE PROTESE VALVAR"], stock: 0, targetStock: 2 },
            // (Adicione 'targetStock' aos outros itens conforme necessário)
            { title: "DESBRIDAMENTO", procedures: ["CURATIVO/DESBRIDAMENTO", "RESSUTURA DE PAREDE"], stock: 0, targetStock: 10 },
            { title: "EXODONTIA", procedures: ["EXODONTIA"], stock: 0, targetStock: 5 },
            { title: "TQT", procedures: ["TRAQUEOSTOMIA"], stock: 0, targetStock: 5 },
            { title: "NEURO", procedures: ["MICROCIRURGIA PARA TUMOR/ANEURISMA INTRACRANIANO/CRANIOTOMIA", "ARTRODESE CERVICAL"], stock: 0, targetStock: 3 },
            { title: "OTORRINO", procedures: ["AMIGDALECTOMIA"], stock: 0, targetStock: 5 },
            { title: "AMPUTAÇÃO", procedures: ["AMPUTAÇÃO"], stock: 0, targetStock: 5 },
            { title: "CPRE", procedures: ["COLANGIOPANCREATOGRAFIA"], stock: 0, targetStock: 5 }
        ];

        // --- MODIFICADO --- Adicionadas novas referências de elementos
        const tablesContainer = document.getElementById('tables-container');
        const saveBtn = document.getElementById('save-btn');
        const addTableBtn = document.getElementById('add-table-btn');
        const exportBtn = document.getElementById('export-btn');
        const resetBtn = document.getElementById('reset-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const moonIcon = document.getElementById('theme-toggle-moon-icon');
        const sunIcon = document.getElementById('theme-toggle-sun-icon');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCancelBtn = document.getElementById('modal-cancel');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const searchInput = document.getElementById('search-input');
        const suggestionBtn = document.getElementById('suggestion-btn');
        const suggestionSection = document.getElementById('suggestion-section');
        const suggestionContent = document.getElementById('suggestion-content');

        let onConfirmCallback = null;
        
        const applyTheme = (theme) => { /* ... (código existente sem alterações) ... */ };
        themeToggleBtn.addEventListener('click', () => { /* ... (código existente sem alterações) ... */ });
        const showModal = (title, contentHtml, confirmText = 'Confirmar', onConfirm) => { /* ... (código existente sem alterações) ... */ };
        const hideModal = () => { /* ... (código existente sem alterações) ... */ };
        modalCancelBtn.addEventListener('click', hideModal);
        modalConfirmBtn.addEventListener('click', () => { if (onConfirmCallback) onConfirmCallback(); });
        modal.addEventListener('keydown', (e) => { /* ... (código existente sem alterações) ... */ });

        const createProcedureItemHTML = (text) => { /* ... (código existente sem alterações) ... */ };
        
        // --- MODIFICADO --- Função de criação de tabela agora inclui o campo 'Estoque Alvo'
        const createTableHTML = (title, procedures = [], stockCount = 0, targetStock = 10) => {
            const tableEl = document.createElement('div');
            tableEl.className = 'procedure-table bg-gray-200 dark:bg-gray-700 rounded-xl p-4 shadow-lg flex flex-col h-full';
            tableEl.setAttribute('data-table-title', title);
            tableEl.setAttribute('data-stock-count', stockCount);
            tableEl.setAttribute('data-target-stock', targetStock); // Armazena o alvo
            const proceduresHTML = procedures.map(proc => createProcedureItemHTML(proc)).join('');
            tableEl.innerHTML = `
                <header class="flex justify-between items-center mb-4 pb-2 border-b-2 border-gray-300 dark:border-gray-600">
                    <h2 class="table-title text-xl font-bold text-gray-700 dark:text-gray-200 flex-1 pr-2">${title}</h2>
                    <div class="flex items-center gap-2">
                        <button class="stock-minus-btn bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-lg hover:bg-red-600 transition">-</button>
                        <span class="stock-count-display text-lg font-bold w-8 text-center">${stockCount}</span>
                        <button class="stock-plus-btn bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-lg hover:bg-green-600 transition">+</button>
                    </div>
                    <div class="flex items-center gap-2 ml-4">
                        <label for="target-stock-${title.replace(/\s+/g, '-')}" class="text-sm font-semibold">Alvo:</label>
                        <input type="number" id="target-stock-${title.replace(/\s+/g, '-')}" class="target-stock-input w-16 text-center bg-white dark:bg-gray-600 rounded-md border border-gray-300 dark:border-gray-500" value="${targetStock}">
                    </div>
                    <div class="flex items-center gap-2 ml-4">
                        <button class="edit-table-btn text-gray-500 hover:text-blue-600 dark:hover:text-blue-400" title="Editar título da tabela">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button class="delete-table-btn text-gray-500 hover:text-red-600 dark:hover:text-red-400" title="Deletar tabela">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                        </button>
                    </div>
                </header>
                <ul class="procedure-list flex-grow overflow-y-auto pr-1" style="max-height: 60vh;">${proceduresHTML}</ul>
                <footer class="mt-4"><button class="add-procedure-btn w-full bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 dark:hover:bg-gray-500 transition">Adicionar Procedimento</button></footer>
            `;
            return tableEl;
        };
        
        // --- NOVO: Função para renderizar as sugestões ---
        const renderSuggestions = () => {
            const currentData = getCurrentData();
            const suggestions = currentData.filter(table => table.stock < table.targetStock);
            
            if (suggestions.length === 0) {
                suggestionContent.innerHTML = '<p class="text-green-600 dark:text-green-400">Tudo em ordem! Não há kits para confeccionar.</p>';
                return;
            }

            let suggestionsHTML = '<ul class="list-disc list-inside space-y-2">';
            suggestions.forEach(suggestion => {
                const needed = suggestion.targetStock - suggestion.stock;
                suggestionsHTML += `
                    <li class="text-gray-700 dark:text-gray-300">
                        Confeccionar <strong class="font-semibold text-yellow-600 dark:text-yellow-400">${needed}</strong> kit(s) para <strong class="font-semibold">${suggestion.title}</strong> para atingir o alvo de ${suggestion.targetStock}.
                    </li>
                `;
            });
            suggestionsHTML += '</ul>';
            suggestionContent.innerHTML = suggestionsHTML;
        };

        const renderAllTables = () => {
            tablesContainer.innerHTML = '';
            const savedData = localStorage.getItem('procedimentosData');
            let dataToRender = savedData ? JSON.parse(savedData) : initialData;
            dataToRender.forEach(tableData => {
                // Garante que os dados antigos tenham as novas propriedades
                const stock = tableData.stock || 0;
                const targetStock = tableData.targetStock || 10; // Valor padrão de 10
                tablesContainer.appendChild(createTableHTML(tableData.title, tableData.procedures, stock, targetStock));
            });
            renderSuggestions(); // Renderiza as sugestões após carregar as tabelas
        };
        
        const handleSearch = () => { /* ... (código existente sem alterações) ... */ };
        const handleAddTable = () => { /* ... (código existente sem alterações) ... */ };
        const handleEditTableTitle = (button) => { /* ... (código existente sem alterações) ... */ };
        const handleDeleteTable = (button) => { /* ... (código existente sem alterações) ... */ };
        const handleAddProcedure = (button) => { /* ... (código existente sem alterações) ... */ };
        const handleEditProcedure = (button) => { /* ... (código existente sem alterações) ... */ };
        const handleDeleteProcedure = (button) => { /* ... (código existente sem alterações) ... */ };

        // --- MODIFICADO --- Função de salvar agora inclui 'targetStock'
        const getCurrentData = () => {
            return Array.from(document.querySelectorAll('.procedure-table')).map(table => ({
                title: table.dataset.tableTitle,
                procedures: Array.from(table.querySelectorAll('.procedure-item')).map(item => item.dataset.procedureName),
                stock: parseInt(table.dataset.stockCount, 10) || 0,
                targetStock: parseInt(table.dataset.targetStock, 10) || 0
            }));
        };
        
        const saveToLocalStorage = () => { /* ... (código existente sem alterações) ... */ };
        const exportToFile = () => { /* ... (código existente sem alterações) ... */ };
        const resetData = () => { /* ... (código existente sem alterações) ... */ };

        // --- Event Listeners ---
        addTableBtn.addEventListener('click', handleAddTable);
        saveBtn.addEventListener('click', saveToLocalStorage);
        exportBtn.addEventListener('click', exportToFile);
        resetBtn.addEventListener('click', resetData);
        searchInput.addEventListener('input', handleSearch);
        
        // --- NOVO --- Event listener para o botão de sugestões
        suggestionBtn.addEventListener('click', () => {
            suggestionSection.scrollIntoView({ behavior: 'smooth' });
        });

        tablesContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            const input = e.target.closest('input');

            // Lógica dos botões
            if (button) {
                if (button.classList.contains('edit-table-btn')) handleEditTableTitle(button);
                else if (button.classList.contains('delete-table-btn')) handleDeleteTable(button);
                else if (button.classList.contains('add-procedure-btn')) handleAddProcedure(button);
                else if (button.classList.contains('edit-procedure-btn')) handleEditProcedure(button);
                else if (button.classList.contains('delete-procedure-btn')) handleDeleteProcedure(button);
                else if (button.classList.contains('stock-plus-btn')) {
                    const tableEl = button.closest('.procedure-table');
                    let count = parseInt(tableEl.dataset.stockCount, 10);
                    count++;
                    tableEl.dataset.stockCount = count;
                    tableEl.querySelector('.stock-count-display').textContent = count;
                    renderSuggestions(); // Atualiza as sugestões
                }
                else if (button.classList.contains('stock-minus-btn')) {
                    const tableEl = button.closest('.procedure-table');
                    let count = parseInt(tableEl.dataset.stockCount, 10);
                    if (count > 0) {
                        count--;
                        tableEl.dataset.stockCount = count;
                        tableEl.querySelector('.stock-count-display').textContent = count;
                        renderSuggestions(); // Atualiza as sugestões
                    }
                }
            }

            // --- NOVO: Lógica para o input de estoque alvo ---
            if (input && input.classList.contains('target-stock-input')) {
                input.addEventListener('input', () => {
                    const tableEl = input.closest('.procedure-table');
                    tableEl.dataset.targetStock = input.value;
                    renderSuggestions(); // Atualiza as sugestões em tempo real
                });
            }
        });
        
        // --- Inicialização ---
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            renderAllTables();
        });
    </script>
</body>
</html>
